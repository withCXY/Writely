<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translate-as-You-Type Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 2px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .editable-section {
            border: 2px solid #4285f4;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #fff;
            min-height: 100px;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .fix-info {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 10px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-enabled {
            background-color: #4caf50;
        }
        .status-disabled {
            background-color: #f44336;
        }
        .settings-info {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>🌐 Translate-as-You-Type Test</h1>
    
    <div class="fix-info">
        <h3>✅ Feature Restored: Translate-as-You-Type</h3>
        <p><strong>Status:</strong> The translate-as-you-type functionality has been restored to the current content.js</p>
        <p><strong>How it works:</strong> Type in your source language, pause for 1.5 seconds, and the text will automatically translate</p>
        
        <h4>Technical Implementation:</h4>
        <ul>
            <li>🎯 <strong>Input Detection:</strong> Monitors input events in editable elements</li>
            <li>⏱️ <strong>Smart Timing:</strong> 1.5-second delay to avoid interrupting typing flow</li>
            <li>📝 <strong>Block-Level Translation:</strong> Translates current paragraph/block only</li>
            <li>� <strongg>Cursor Positioning:</strong> Always places cursor at text end after translation</li>
            <li>🚫 <strong>Duplicate Prevention:</strong> Avoids re-translating the same text</li>
        </ul>
    </div>

    <div class="settings-info">
        <h3>⚙️ Required Settings</h3>
        <p><strong>Before testing, make sure to configure these in the extension popup:</strong></p>
        <ol>
            <li>✅ Enable "Translate-as-you-type" checkbox</li>
            <li>🌍 Set your source language (e.g., Chinese, Spanish, etc.)</li>
            <li>🎯 Set your target language (usually English)</li>
            <li>🔑 Ensure you have either Gemini API key or Google Cloud API key configured</li>
        </ol>
        
        <p><strong>Current Status:</strong></p>
        <div id="settings-status">
            <div><span class="status-indicator" id="translate-enabled-status"></span>Translate-as-you-type: <span id="translate-enabled-text">Checking...</span></div>
            <div><span class="status-indicator" id="source-lang-status"></span>Source Language: <span id="source-lang-text">Checking...</span></div>
            <div><span class="status-indicator" id="target-lang-status"></span>Target Language: <span id="target-lang-text">Checking...</span></div>
        </div>
    </div>

    <h2>🧪 Test Areas</h2>
    
    <p><strong>Instructions:</strong> Type in your source language in the areas below. After you stop typing for 1.5 seconds, the text should automatically translate.</p>

    <div class="test-section">
        <h3>Test 1: ContentEditable Div</h3>
        <div class="editable-section" contenteditable="true" placeholder="Type here in your source language...">
            Start typing here...
        </div>
        <p><strong>Expected:</strong> Text translates automatically after 1.5 seconds of no typing</p>
    </div>

    <div class="test-section">
        <h3>Test 2: Textarea</h3>
        <textarea class="editable-section" rows="4" style="width: 100%; resize: vertical;" placeholder="Type here in your source language...">
Type your text here...
        </textarea>
        <p><strong>Expected:</strong> Currently focuses on contentEditable elements</p>
    </div>

    <div class="test-section">
        <h3>Test 3: Multi-paragraph ContentEditable</h3>
        <div class="editable-section" contenteditable="true">
            <p>First paragraph - type here...</p>
            <p>Second paragraph - type here...</p>
            <p>Third paragraph - type here...</p>
        </div>
        <p><strong>Expected:</strong> Each paragraph translates independently</p>
    </div>

    <div class="test-section">
        <h3>Test 4: Rich Text Editor Simulation</h3>
        <div class="editable-section" contenteditable="true" style="border: 1px solid #ccc; padding: 15px;">
            <div>This is a rich text editor simulation.</div>
            <div><br></div>
            <div>Type your content here in your source language...</div>
            <div><br></div>
            <div>Each line should translate separately.</div>
        </div>
        <p><strong>Expected:</strong> Block-level translation preserving structure</p>
    </div>

    <div class="info">
        <h3>🔍 Testing Instructions:</h3>
        <ol>
            <li><strong>Configure Settings:</strong> Open extension popup and enable translate-as-you-type</li>
            <li><strong>Set Languages:</strong> Choose your source language and target language</li>
            <li><strong>Start Typing:</strong> Type in your source language in any editable area above</li>
            <li><strong>Wait for Translation:</strong> Stop typing and wait 1.5 seconds</li>
            <li><strong>Verify Result:</strong> Text should automatically translate to your target language</li>
            <li><strong>Check Cursor:</strong> Cursor should be placed at the end of translated text</li>
        </ol>
        
        <h3>✅ Success Criteria:</h3>
        <ul>
            <li><strong>Automatic Translation:</strong> Text translates without manual intervention</li>
            <li><strong>Timing:</strong> Translation occurs 1.5 seconds after stopping typing</li>
            <li><strong>Block-Level:</strong> Only the current paragraph/block is translated</li>
            <li><strong>Cursor Positioning:</strong> Cursor moves to end of translated text</li>
            <li><strong>No Duplicates:</strong> Same text doesn't get translated multiple times</li>
            <li><strong>Smooth Experience:</strong> Translation doesn't interrupt typing flow</li>
        </ul>
        
        <h3>🚨 Common Issues:</h3>
        <ul>
            <li>❌ <strong>Not translating:</strong> Check if translate-as-you-type is enabled in popup</li>
            <li>❌ <strong>Wrong language:</strong> Verify source and target language settings</li>
            <li>❌ <strong>API errors:</strong> Ensure API keys are configured correctly</li>
            <li>✅ <strong>Cursor positioning:</strong> Cursor automatically moves to text end for continued typing</li>
        </ul>
    </div>

    <div class="info">
        <h3>🔧 Technical Details:</h3>
        
        <h4>How It Works:</h4>
        <ol>
            <li><strong>Input Detection:</strong> Listens for 'input' events on editable elements</li>
            <li><strong>Element Validation:</strong> Checks if the target element is editable</li>
            <li><strong>Block Finding:</strong> Identifies the current paragraph/block being edited</li>
            <li><strong>Text Extraction:</strong> Gets text content preserving line breaks</li>
            <li><strong>Debounced Translation:</strong> Waits 1.5 seconds before translating</li>
            <li><strong>Smart Replacement:</strong> Replaces text while preserving cursor position</li>
        </ol>
        
        <h4>Supported Elements:</h4>
        <ul>
            <li>✅ <strong>ContentEditable divs</strong></li>
            <li>✅ <strong>Rich text editors</strong></li>
            <li>✅ <strong>Google Docs</strong> (with special handling)</li>
            <li>✅ <strong>Notion pages</strong></li>
            <li>✅ <strong>GitHub text areas</strong></li>
            <li>⚠️ <strong>Simple textareas</strong> (limited support)</li>
        </ul>
        
        <h4>Performance Optimizations:</h4>
        <ul>
            <li>🚫 <strong>Duplicate Prevention:</strong> Tracks last translated text</li>
            <li>⏱️ <strong>Debouncing:</strong> Prevents excessive API calls</li>
            <li>🎯 <strong>Block-Level:</strong> Only translates current paragraph, not entire document</li>
            <li>🔄 <strong>State Management:</strong> Prevents concurrent translations</li>
        </ul>
    </div>

    <script>
        console.log('Translate-as-you-type test page loaded');
        
        // Check current settings
        function checkSettings() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get(['translateAsYouTypeEnabled', 'sourceLang', 'targetLang'], (settings) => {
                    updateSettingsDisplay(settings);
                });
            } else {
                updateSettingsDisplay({
                    translateAsYouTypeEnabled: false,
                    sourceLang: 'Not available (extension context)',
                    targetLang: 'Not available (extension context)'
                });
            }
        }
        
        function updateSettingsDisplay(settings) {
            // Translate enabled status
            const translateEnabled = settings.translateAsYouTypeEnabled;
            document.getElementById('translate-enabled-status').className = 
                'status-indicator ' + (translateEnabled ? 'status-enabled' : 'status-disabled');
            document.getElementById('translate-enabled-text').textContent = 
                translateEnabled ? 'Enabled' : 'Disabled';
            
            // Source language
            const sourceLang = settings.sourceLang || 'Not set';
            document.getElementById('source-lang-status').className = 
                'status-indicator ' + (sourceLang !== 'Not set' ? 'status-enabled' : 'status-disabled');
            document.getElementById('source-lang-text').textContent = sourceLang;
            
            // Target language
            const targetLang = settings.targetLang || 'Not set';
            document.getElementById('target-lang-status').className = 
                'status-indicator ' + (targetLang !== 'Not set' ? 'status-enabled' : 'status-disabled');
            document.getElementById('target-lang-text').textContent = targetLang;
        }
        
        // Monitor input events
        let inputCount = 0;
        document.addEventListener('input', function(e) {
            inputCount++;
            console.log(`📝 Input event #${inputCount} detected on:`, e.target.tagName, e.target.className);
            
            if (e.target.contentEditable === 'true') {
                console.log('  Content:', e.target.textContent.substring(0, 50) + '...');
            }
        });
        
        // Monitor translation attempts
        let translationCount = 0;
        const originalSendMessage = chrome?.runtime?.sendMessage;
        if (originalSendMessage) {
            chrome.runtime.sendMessage = function(message, callback) {
                if (message.type === 'translate' && message.isRealTime) {
                    translationCount++;
                    console.log(`🌐 Real-time translation #${translationCount} requested:`, message.text.substring(0, 30) + '...');
                }
                return originalSendMessage.call(this, message, callback);
            };
        }
        
        // Check settings on load
        checkSettings();
        
        // Refresh settings every 5 seconds
        setInterval(checkSettings, 5000);
    </script>
</body>
</html>"